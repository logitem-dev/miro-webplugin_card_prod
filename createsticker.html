<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    
    <style>
	.canvas-wrapper {
	    position: relative;
	}

	.canvas-wrapper:before{
	            content:"";
	            display: block;
	            padding-top: 50%;
	}

	.canvas-wrapper canvas {
	    position: absolute;
	    top: 0;
	    left: 0;
	}
     </style>
</head>
    
<script src="https://miro.com/app/static/sdk.1.1.js"></script>
<script src="./js/const.js"></script>
<body onload="loadImage()">
<form>

    <input type="file" name="selfile" accept='.jpg' required><br>

    <div class="canvas-wrapper">
	<canvas id = "canvas2" width="446" height="200"></canvas>
 	<canvas id = "canvas" width="446" height="200"></canvas><br>

    <!-- <img src="" name="image1" height='200' width='167'><br> -->

    作業スタッフ番号：<input type='text' name="emploee_id" onchange="drawText(this.name, 35, 30, '')"><br>
	作業スタッフ氏名：<input type='text' name="emploee_name" onchange="drawText(this.name, 90, Math.min(555/getBytes(this.value), maxFont) , 'bold ')"><br>
	作業時間  ：<select name="working_hour" onchange="drawText(this.name, 130, 25, '')">
                    <option value='-'>-</option>
                    <option value='8:00-15:00'>8:00-15:00</option>
                    <option value='8:00-12:00'>8:00-12:00</option>
                    <option value='8:00-13:00'>8:00-13:00</option>
                    <option value='8:00-14:00'>8:00-14:00</option>
                    <option value='8:00-15:00'>8:00-15:00</option>
                    <option value='8:00-16:00'>8:00-16:00</option>
                    <option value='8:00-17:00'>8:00-17:00</option>
                    <option value='8:30-16:00'>8:30-16:00</option>
                    <option value='8:30-17:00'>8:30-17:00</option>
                    <option value='8:30-17:30'>8:30-17:30</option>
                    <option value='8:30-14:00'>8:30-14:00</option>
                    <option value='8:30-15:00'>8:30-15:00</option>
                    <option value='9:00-14:00'>9:00-14:00</option>
                    <option value='9:00-14:30'>9:00-14:30</option>
                    <option value='9:00-15:00'>9:00-15:00</option>
                    <option value='9:00-16:00'>9:00-16:00</option>
                    <option value='9:00-12:00'>9:00-12:00</option>
                    <option value='9:00-13:00'>9:00-13:00</option>
                    <option value='9:00-14:00'>9:00-14:00</option>
                    <option value='9:00-15:00'>9:00-15:00</option>
                    <option value='9:00-15:30'>9:00-15:30</option>
                    <option value='9:00-16:00'>9:00-16:00</option>
                    <option value='9:00-17:00'>9:00-17:00</option>
                    <option value='9:00-18:00'>9:00-18:00</option>
                    <option value='9:15-15:00'>9:15-15:00</option>
                    <option value='9:30-16:00'>9:30-16:00</option>
                    <option value='18:00-24:00'>18:00-24:00</option>
                    <option value='20:00-5:00'>20:00-5:00</option>
                    <option value='10:00-13:00'>10:00-13:00</option>
                    <option value='10:00-14:00'>10:00-14:00</option>
                    <option value='10:00-15:00'>10:00-15:00</option>
                    <option value='10:00-16:00'>10:00-16:00</option>
                    <option value='10:00-17:00'>10:00-17:00</option>
                    <option value='10:00-18:00'>10:00-18:00</option>
                    <option value='12:00-16:00'>12:00-16:00</option>
                    <option value='12:00-17:00'>12:00-17:00</option>
                    <option value='12:15-17:00'>12:15-17:00</option>
                    <option value='15:00-18:00'>15:00-18:00</option>
                    <option value='21:00-6:00'>21:00-6:00</option>
                    
                    </select>
        <br><br>

	<input type='hidden' name='dataurl'><br>
    <input type='hidden' name='oldwidghtId'><br>

	<button type="button" name='register' onclick='UploadAndRegister(false)'>登録</button>
    <button type="button" name='copy' onclick='UploadAndRegister(true)' disabled>複製</button>
	<button type="button" id="close" onclick='closeWindow()'>閉じる</button>
    </div>    

</form>


<script>

    miro.onReady(() => {
        getCardInfo();
    });

    async function  getCardInfo(){
        let selectedWidgets = await miro.board.selection.get();
        let images = selectedWidgets.filter((widget) => widget.type === 'IMAGE');

        if(images.length !== 0){

            var tojson = JSON.stringify(images[0].metadata);
            var fromjson = JSON.parse(tojson);

            if(([client_id] in fromjson) && ('staffid' in fromjson[client_id])){

                document.getElementsByName("copy")[0].disabled=false;

                var staffid = fromjson[client_id]['staffid'];
                var staffName = fromjson[client_id]['staffName'];
                var workHour = fromjson[client_id]['working_hour'];

                // 既存カードの値をセット
                document.getElementsByName("emploee_id")[0].value = staffid;
                document.getElementsByName("emploee_name")[0].value = staffName;

                var optionWorkHour = document.querySelectorAll("select[name=working_hour] option");
                    for(var option of optionWorkHour) {
                        if(option.textContent === workHour) {
                            option.selected = true;
                        } else {
                            option.selected = false;
                        }
                    }                
                document.getElementsByName("oldwidghtId")[0].value = images[0].id;
                
                var loadimage = new Image();
                await fetch(api_uri + 's3/' + staffid + '.png' , {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                }).then(function (response) {
                    return response.blob();
                }).then(function(blob) {
                    var objectURL = URL.createObjectURL(blob);
                    loadimage.src = objectURL;
                });

                loadimage.onload = (function () {
                    //画像ロードが完了してからキャンバスの準備をする
                    var canvas = document.getElementById('canvas');
                    var ctx = canvas.getContext('2d');
                    //キャンバスのサイズを画像サイズに合わせる
                    canvas.width = loadimage.width;
                    canvas.height = loadimage.height;
                    //キャンバスに画像を描画（開始位置0,0）
                    ctx.drawImage(loadimage, 0, 0);
                    // DataUrlをクリア
                    document.getElementsByName('dataurl')[0].value = "";
                });

            }
        }	       

    }

    async function loadImage(){
        //画像を読み込んでImageオブジェクトを作成する

        // 初期画像(テキスト等なし)
        var image = new Image();
        image.src = './img/sticker.png';
        image.onload = (function () {
            //画像ロードが完了してからキャンバスの準備をする
            var canvas = document.getElementById('canvas2');
            var ctx = canvas.getContext('2d');
            //キャンバスのサイズを画像サイズに合わせる
                canvas.width = image.width;
                canvas.height = image.height;
            //キャンバスに画像を描画（開始位置0,0）
            ctx.drawImage(image, 0, 0);
            // DataUrlをクリア
            document.getElementsByName('dataurl')[0].value = "";
        });  
    } 

        var obj1 = document.getElementsByName("selfile");
        
        //ダイアログでファイル選択時にCanvas内に画像を表示する
        obj1[0].addEventListener("change",function(evt){

            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            var imagefile = evt.target.files[0];


            var blobUrl = window.URL.createObjectURL(imagefile);

            var image = new Image();
            image.src = blobUrl;


            image.addEventListener('load', function(){
                // 一旦写真の範囲をクリア
                clearPicture(context, 1, 5, 145, 162);                    
                context.drawImage(image,5,10, 130, 156);
            }, false);
	    
        
        },false);

		// 文字のバイト数取得(全角を2バイトとする)
		function getBytes(value){
		    var length = 0;
		    for (var i = 0; i < value.length; i++) {
			    var c = value.charCodeAt(i);
			    if ((c >= 0x0 && c < 0x81) || (c === 0xf8f0) || (c >= 0xff61 && c < 0xffa0) || (c >= 0xf8f1 && c < 0xf8f4)) {
			        length += 1;
			    } else {
			        length += 2;
			    }
		    }
		    return length;
		}

        // Canvas内に文字を表示する
        function drawText(name, ypos, fontsize, font){

            var text = document.getElementsByName(name);

            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            context.font = font + fontsize + 'px serif';
            context.fillStyle = '#404040';
            // 右寄せで表示
            context.textBaseline = 'center';
            context.textAlign = 'right';
            //座標を指定して文字を描く
            var x = (canvas.width -15);
            var y = (canvas.offsetTop + ypos);

			var yclearpos = fontsize-5;
			var height = fontsize+6;
			if(name === 'emploee_name'){
				// 従業員名称は最大フォント数でクリアする範囲を設定
				yclearpos = maxFont - 5;
				height = maxFont + 6;
			
			}
       		clearText(context, x-282, ypos - yclearpos, height);           // 範囲クリア位置調整
            context.fillText(text[0].value, x, y);
        }

        // アップロード確定時にCanvasを合成する(編集用と確定用　編集用はクリア処理が入るため)
        async function concatCanvas(){
            const canvas = document.getElementById('canvas2');
            const ctx = canvas.getContext("2d");

            const image1 = await getImagefromCanvas('canvas');
            ctx.drawImage(image1, 0, 0, canvas.width, canvas.height);
        }

        // Canvasオブジェクトからイメージを取得する
        function getImagefromCanvas(id){
            return new Promise((resolve, reject) => {
                const image = new Image();
                const ctx = document.getElementById(id).getContext("2d");
                image.onload = () => resolve(image);
                image.onerror = (e) => reject(e);
                image.src = ctx.canvas.toDataURL();
            });                            
        }

        // 編集用のCanvasから文字をクリアする
        function clearText(context, x,y, height){
            context.clearRect(x, y, 300, height);
        }

        // 編集用のCanvasから写真をクリアする
        function clearPicture(context, x, y, width, height){
            context.clearRect(x, y, width, height);
        }

        // 画面を閉じる
        function closeWindow(){
            miro.board.ui.closeModal();
        }

        // 画像ファイルをアップロードしてImageWidgetを作成する
        async function UploadAndRegister(copyFlag){

            if(confirm('データをアップロードします。よろしいですか？') === false) {
	            return false;
	        }

            document.body.style.cursor = 'wait'; 

            // 合成された画像の一時ファイルを作成
            var emploeeId = document.getElementsByName("emploee_id")[0].value;

            // 選択されたカードがある場合は旧WidgetIdを取得
            var oldid = document.getElementsByName("oldwidghtId")[0].value;

            if(copyFlag === false && oldid){
                // 登録(上書き保存)
                if(confirm('カードを上書き保存します。よろしいですか？') === false) {
                    document.body.style.cursor = 'auto'; 
                    return false;
                }
            }else{
                // 新規登録・複製時
                oldid = "";

                // 既存の同一社員番号のカードが存在しないか確認する
                var allImages = await miro.board.widgets.get({type: 'IMAGE'});

                allImages.forEach(image => {

                    var tojson = JSON.stringify(image.metadata);
                    var fromjson = JSON.parse(tojson);
                    
                    if(([client_id] in fromjson) && ('staffid' in fromjson[client_id])){
                        if(fromjson[client_id]['staffid'] === emploeeId){
                            oldid = image.id;
                        }
                        
                    }
                });

                if(oldid){
                    if(confirm('社員番号' + emploeeId + 'のカードはすでに存在します。上書き保存しますか？') === false) {
                        document.body.style.cursor = 'auto'; 
                        return false;
                    }
                }
            }

            await createWidget(emploeeId, oldid);

            // 一時ファイルの削除
            await fetch(api_uri + emploeeId  + '.png' , {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: '{}'
            }).then(function (response) {
                console.log(response.text());
            }).then(function (text) {
                console.log("RESULT: " + text);
            });

            document.body.style.cursor = 'auto'; 

            // ModalWindowを閉じる
            miro.board.ui.closeModal()

        }

        // ImageWidgetの作成
        async function createWidget(emploeeId, oldid){

	        // アップロード前に一旦送信用画像情報をクリア
	        await loadImage();
		    await concatCanvas();

	    	document.getElementsByName('dataurl')[0].value = await document.getElementById('canvas2').toDataURL();

            setTimeout(function(){
                if(document.getElementsByName('dataurl')[0].value === ""){
                    return false;
                }
            })

            var emploeeName = document.getElementsByName("emploee_name")[0].value;
            var workingHour = document.getElementsByName("working_hour")[0].value;

            var dataurl = document.getElementsByName('dataurl')[0].value;

            await fetch(api_uri, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'emploee_id' : emploeeId , 'dataurl' : dataurl })
            }).then(function (response) {
                console.log(response.text());
            }).then(function (text) {
                console.log("RESULT: " + text);
            });

            if(oldid){

                // 元カードの削除
                var oldwidget = await miro.board.widgets.get({id: oldid});
                await miro.board.widgets.deleteById(oldwidget[0].id);
                // Widgetの作成
                await miro.board.widgets.create({ type: 'image', x: oldwidget[0].x, y: oldwidget[0].y, scale: 1.0, url: api_uri + emploeeId + '.png', metadata:{[client_id] :{staffid: emploeeId, staffName: emploeeName, working_hour: workingHour}}});

                return;
            }
            await miro.board.widgets.create({ type: 'image', scale: 1.0, url: api_uri + emploeeId + '.png', metadata:{[client_id] :{staffid: emploeeId, staffName: emploeeName, working_hour: workingHour}}});
        }



    </script>        
  </body>    
    
</html>
